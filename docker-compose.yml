name: Stock-Research-Assistant
services:
  # 1. Snapshot Data Initialization Service
  init_snapshot:
    image: ghcr.io/akashdesarda/stock-research-platform/srp-snapshot-data:latest
    volumes:
      - ./config.toml:/tmp/config.toml
      - shared-data:/shared
    environment:
      FORCE_DECOMPRESSION: "false" # Force decompression only if required
    command: ["uv", "run", "/snapshot_data_decompress.py"]
    tty: true
  # 2. Stock Database API Service
  stockdb-api:
    build:
      context: ./stockdb
      dockerfile: Dockerfile
    image: ghcr.io/akashdesarda/stock-research-platform/srp-stockdb-api:latest
    pull_policy: always
    ports:
      - "8000:8000"
    volumes:
      - shared-data:/shared
    environment:
      CONFIG_FILE: /shared/assets/config.toml
      DOCKER_CONTAINER: "true" # Explicit Docker environment flag
    depends_on:
      init_snapshot:
        condition: service_completed_successfully
    tty: true
  # 3. MLflow tracking server
  mlflow:
    image: ghcr.io/mlflow/mlflow
    ports:
      - "5000:5000"
    volumes:
      - shared-data:/shared
    environment:
      MLFLOW_TRACKING_URI: http://0.0.0.0:5000
      MLFLOW_ARTIFACT_ROOT: /shared/mlflow/artifacts
    command: >
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri sqlite:////shared/mlflow/mlflow.db
      --default-artifact-root /shared/mlflow/artifacts
    tty: true

volumes:
  shared-data:
    name: "sra-shared-data"
